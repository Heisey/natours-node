// ?????????????????????????????????????????????????????????
// ??????????????????? Tour Controller ?????????????????????
// ?????????????????????????????????????????????????????????

// ??????????????????? File Modules ????????????????????????

// ??????????????????? Node Modules ????????????????????????
const fs = require('fs');
const path = require('path');

// ??????????????????? Vendor Modules ??????????????????????

// todo
const tours = JSON.parse(
    fs.readFileSync(path.join(__dirname, '../../dev-data/data/tours-simple.json'))
);

// ??????????????????? Middleware ??????????????????????????

// ~~ Check req body
exports.checkBody = (req, res, next) => {
    if (!req.body.name || !req.body.price) {
        return res.status(400).send({
            status: 'fail',
            message: 'Missing Fields'
        })
    }

    next()
}

// ~~ Check for valid ID
exports.checkID = (req, res, next, va) => {

    // !! Error Handler for 404 
    if (req.params.id * 1 > tours.length) {

        // ^^ Response
        return res.status(404).json({
            status: 'fail',
            message: 'Invalid ID'
        })
    }

    next()
}


// ??????????????????? route Handlers ??????????????????????

// ~~ Get All Tours
exports.getAllTours = (req, res, next) => {

    // ^^ Response
    res.status(200).json({
        status: 'success',
        requestTime: req.requestTime,
        results: tours.length,
        data: {
            tours
        }
    });
};

// ~~ Get Tour By ID
exports.getTour = (req, res, next) => {

    // ~~ Convert param.id to Number
    const id = req.params.id * 1;

    // ~~ Find tour by id
    const tour = tours.find(el => el.id === id);

    // ^^ Response
    res.status(200).json({
        status: 'success',
        data: {
            tour
        }
    });
};

// ~~ Create Tour
exports.createTour = (req, res, next) => {
    // ~~ Create a new id
    const id = tours.length + 1;

    // ~~ create new object with id and req.body
    const newTour = Object.assign({
            id
        },
        req.body
    );

    // ~~ push new tour to tours array
    tours.push(newTour);

    // todo
    fs.writeFile(
        path.join(__dirname, 'dev-data/data/tours-simple.json'),
        JSON.stringify(tours),
        err => {
            res.status(201).send({
                status: 'success',
                data: {
                    tour: newTour
                }
            });
        }
    );
};

// ~~ Update Tour
exports.updateTour = (req, res, next) => {
    // ~~ Convert param.id to Number
    const id = req.params.id * 1;

    // ^^ Response
    res.status().json({
        status: 'success',
        data: {}
    });
};

// ~~ Delete Tour
exports.deleteTour = (req, res, next) => {
    // ~~ Convert param.id to Number
    const id = req.params.id * 1;

    // ^^ Response
    res.status(204).json({
        status: 'success',
        data: null
    });
};