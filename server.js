// ?????????????????????????????????????????????????????????
// ??????????????????? Server ??????????????????????????????
// ?????????????????????????????????????????????????????????

// ??????????????????? File Modules ????????????????????????
const app = require('./app')

// ??????????????????? Vendor Modules ??????????????????????
const chalk = require('chalk');
const dotenv = require('dotenv');
const mongoose = require('mongoose');

// ~~ Set environment variables
dotenv.config({
    path: './config.env'
})

// ~~ Global Varialbes
const log = console.log;

// ~~ Set Port
const PORT = process.env.PORT;

// ~~ Create DB String
const DB = process.env.DB.replace('<PASSWORD>', process.env.DBPASSWORD);

// ~~ Start App Server
server = app.listen(PORT, () => {

    // ~~ Check Env to set custom response
    if (process.env.NODE_ENV === 'development') {
        log(chalk.blue.bold.inverse(`<<<<< App is Running on Port ${PORT} >>>>>`));
    } else {
        log(`<<<<< App is Running on Port ${PORT} >>>>>`)
    }

});

// ## Connect to DB
mongoose.connect(DB, {
    useNewUrlParser: true,
    useCreateIndex: true,
    useFindAndModify: false,
    useUnifiedTopology: true
}).then(() => {

    // ~~ Check Env to set custom response
    if (process.env.NODE_ENV === 'development') {
        log(chalk.green.bold.inverse('<<<<< DB Connected Successfully >>>>>'))
    } else {
        log('<<<<< DB Connected Successfully >>>>>')
    }

})

// ??????????????????? Global Error Handler ????????????????

process.on('unhandledRejection', (err) => {
    console.log(err.name, err.message);
    console.log('Unhandled Rejection!!! Shutting Down...')
    server.close(() => {
        process.exit(1);
    })
})

process.on('uncaughtException', (err) => {
    console.log(err.name, err.message);
    console.log('Uncaught Exception!!! Shutting Down...')
    server.close(() => {
        process.exit(1);
    })
})